on: push
name: Build Prod
jobs:
  build:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16.17.0'
      - uses: "shivammathur/setup-php@v2"
        with:
          php-version: "latest"
      - name: Install composer dependencies
        uses: ramsey/composer-install@v2
        with:
          working-directory: "src"
      - name: Install node dependencies
        working-directory: ./src
        run: |
          npm install;
      - name: Build vite
        run: |
          cd ./src
          ls resources/js/Components
          npm run build
      - name: Deploy
        run: |
          echo ${{ secrets.STACKHERO_DOCKER_HOST }}
          echo ${{secrets.STACKHERO_DOCKER_HOST}} | sed 's/./& /g'
          cd /tmp/
          curl -o certificates.tar https://docker:${{ secrets.STACKHERO_DOCKER_CERTIFICATES_PASSWORD }}@${{ secrets.STACKHERO_DOCKER_HOST }}/stackhero/docker/certificates.tar
          tar -xf certificates.tar
          (docker context rm -f ${{ secrets.STACKHERO_DOCKER_HOST }} 2> /dev/null || true)
          docker context create ${{ secrets.STACKHERO_DOCKER_HOST }} --description "${{ secrets.STACKHERO_DOCKER_SERVICE_ID }} (${{ secrets.STACKHERO_DOCKER_HOST }})" --docker "host=tcp://${{ secrets.STACKHERO_DOCKER_HOST }}:2376,ca=ca.pem,cert=cert.pem,key=key.pem"